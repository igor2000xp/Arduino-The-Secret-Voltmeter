Автор этого кода Igor (Igor2000xp)

https://github.com/igor2000xp/Arduino-The-Secret-Voltmeter

Этот скетч предназначен для использования Ардуино в качестве 4-канального вольтметра. 
Уровень комментариев, на который ориентировался автор при их написании - это любители, которые понимают основы языка Ардуино и знают основные понятия ассемблерных вставок для управления регистрами Ардуино.

Автор планирует использовать этот код для сборки устройства измерения внешней температуры с литиевым аккумулятором и солнечной батареей. Термометр собран на Ардуино, использует датчик температуры DS18B20 и OLED дисплей 128х64. В качестве вольтметра используется эта же плата Ардуино. На входе был поставлен делитель напряжения с двумя резисторами 3,3 кОм на каждый канал. Таким образом, вольтметр измерял напряжение от 0 до 10 В с точностью примерно 0,01 В. АЦП у плат Ардуино 10-битный и эта точность соответствует дискретности от 0 до 1023. Именно в этом диапазоне выдает АЦП целые числа при измерении напряжения на входе АЦП.

 Автор для экспериментов использовал Ардуино Про мини 5В, 16МГц. Однако практически любая Ардуино может быть использована. Необходимо проверить на соответствие даташит величины внутреннего опорного напряжения и соответствие битов регистров управления АЦП ADMUX и ADCSRA.

Автор будет благодарен конструктивной критике кода и его оптимизации.


По мнению автора есть несколько причин, которые могут негативно повлиять на использование Ардуино в качестве вольтметра.
1. Нестабильность питающего напряжения Ардуино. На плате Ардуино встроен параметрический стабилизатор напряжения (5В или 3,3В в зависимости от модификации платы). Для получения стабильного напряжения +5В на вывод RAW необходимо подать 6...12В. Многие подают 5В. При этом Ардуино будет тоже работать, но внутренний стабилизатор Ардуино выдавать порядка 4,5...4,8 В и это напряжение будет не совсем стабильно. Внутренний стабилизатор в этом случае работает в нештатном режиме.
Кроме того автор между источником 6...12 В до входа поставил фильтр из конденсатора 100...480 мкФ и дросселя 10...200 мкГн, непосредственно между входом RAW и землей керамический конденсатор 0,1...1,0 мкФ.
Также между Vcc и землей танталовый конденсатор 10...100 мкФ. Показания вольтметра стали намного стабильнее.

2. В силу разных причин (в основном температуры платы Ардуино) напряжение на входах Vcc и AVcc может слегка изменяться и это повлияет на точность измерения напряжения. Для периодической корректировки измеренного внутреннего опорного напряжения (напряжения питания) автор использовал код SCOTT (https://provideyourown.com/2012/secret-arduino-voltmeter-measure-battery-voltage/).

3. На точность измерения может влиять цифровой шум, который создает сам процессор Atmega328p. Для его уменьшения в процессор встроен один из режимов сна - ADC Noise Reduction Mode. Код для его использования обсуждался в интернете и на форумах (например: http://forum.arduino.cc/index.php/topic,38119.0.html#14). Но полностью рабочего кода автор не нашел. Поэтому написал собственный скетч и объединил метод коррекции измерения внутреннего опорного напряжения АЦП и ADC Noise Reduction Mode в одном скетче. 

В результате, удалось добиться точности измерения напряжения близкой к предельно достижимой.
